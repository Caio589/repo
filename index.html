<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PDV Barbearia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:url("https://images.unsplash.com/photo-1503951914875-452162b0f3f1");
  background-size:cover;
  background-position:center;
}
.overlay{background:rgba(0,0,0,.7);min-height:100vh}
.menu{
  position:fixed;left:0;top:0;bottom:0;width:70px;
  background:rgba(0,0,0,.4);
  display:flex;flex-direction:column;align-items:center;padding-top:20px
}
.menu button{
  background:none;border:none;color:#f1c40f;
  font-size:22px;margin:15px 0;cursor:pointer
}
.content{margin-left:90px;padding:20px;color:#fff}
.section{display:none}
.section.active{display:block}
input,select,button{
  padding:8px;border-radius:6px;border:none;margin:4px 0
}
button{cursor:pointer;font-weight:bold}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid rgba(255,255,255,.2);padding:6px}
.total{font-size:20px;color:#2ecc71}
.neg{color:#e74c3c}
</style>
</head>

<body>
<div class="overlay">

<div class="menu">
  <button onclick="show('pdv')">ðŸ’ˆ</button>
  <button onclick="show('despesas')">ðŸ§¾</button>
  <button onclick="show('financeiro')">ðŸ“Š</button>
  <button onclick="show('mensal')">ðŸ“†</button>
</div>

<div class="content">

<!-- PDV -->
<div id="pdv" class="section active">
  <h2>PDV / Caixa</h2>
  <p id="statusCaixa"></p>

  <input id="valorAbertura" type="number" placeholder="Valor abertura do caixa">
  <button onclick="abrirCaixa()">Abrir Caixa</button>

  <hr>

  <select id="produto"></select>

  <select id="pagamento">
    <option value="dinheiro">Dinheiro</option>
    <option value="pix">Pix</option>
    <option value="cartao">CartÃ£o</option>
  </select>

  <button onclick="addItem()">Adicionar</button>

  <table id="carrinho"></table>
  <p class="total">Total: R$ <span id="total">0.00</span></p>

  <button onclick="finalizarVenda()">Finalizar Venda</button>
  <button onclick="fecharCaixa()">Fechar Caixa</button>
  <button onclick="pdfFechamento()">ðŸ“„ PDF Fechamento</button>

  <div id="resumoCaixa"></div>
</div>

<!-- DESPESAS -->
<div id="despesas" class="section">
  <h2>Despesas</h2>
  <input id="descDespesa" placeholder="DescriÃ§Ã£o">
  <input id="valorDespesa" type="number" placeholder="Valor">
  <button onclick="salvarDespesa()">Adicionar</button>
  <ul id="listaDespesas"></ul>
</div>

<!-- FINANCEIRO -->
<div id="financeiro" class="section">
  <h2>Financeiro</h2>
  <p>Vendas: R$ <span id="fat">0.00</span></p>
  <p>Despesas: R$ <span id="desp">0.00</span></p>
  <p class="total">Lucro: R$ <span id="lucro">0.00</span></p>
</div>

<!-- RELATÃ“RIO MENSAL -->
<div id="mensal" class="section">
  <h2>RelatÃ³rio Mensal</h2>

  <input type="month" id="mesRelatorio">
  <button onclick="gerarRelatorioMensal()">Gerar</button>
  <button onclick="pdfRelatorioMensal()">ðŸ“„ PDF Mensal</button>

  <div id="resumoMensal"></div>
  <ul id="listaMensal"></ul>
</div>

</div>
</div>

<script>
function show(id){
  document.querySelectorAll(".section")
    .forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

const rawDB = JSON.parse(localStorage.getItem("db")||"{}");
const db = {
  produtos: rawDB.produtos || [
    {nome:"Corte",valor:30},
    {nome:"Barba",valor:20}
  ],
  vendas: rawDB.vendas || [],
  despesas: rawDB.despesas || [],
  caixa: rawDB.caixa || {aberto:false,abertura:0}
};

let carrinho=[];

function save(){localStorage.setItem("db",JSON.stringify(db));}

/* ===== CAIXA ===== */
function abrirCaixa(){
  db.caixa.aberto=true;
  db.caixa.abertura=Number(valorAbertura.value||0);
  db.vendas=[];
  db.despesas=[];
  carrinho=[];
  save();render();
}

function fecharCaixa(){
  const pix=db.vendas.filter(v=>v.pagamento==="pix").reduce((s,v)=>s+v.total,0);
  const cartao=db.vendas.filter(v=>v.pagamento==="cartao").reduce((s,v)=>s+v.total,0);
  const dinheiro=db.vendas.filter(v=>v.pagamento==="dinheiro").reduce((s,v)=>s+v.total,0);
  const despesas=db.despesas.reduce((s,d)=>s+d.valor,0);
  const saldo=db.caixa.abertura+pix+cartao+dinheiro-despesas;

  db.caixa.aberto=false;

  resumoCaixa.innerHTML=`
    <h3>Resumo do Caixa</h3>
    <p>Abertura: R$ ${db.caixa.abertura.toFixed(2)}</p>
    <p>Pix: R$ ${pix.toFixed(2)}</p>
    <p>CartÃ£o: R$ ${cartao.toFixed(2)}</p>
    <p>Dinheiro: R$ ${dinheiro.toFixed(2)}</p>
    <p>Despesas: R$ ${despesas.toFixed(2)}</p>
    <p class="total">Saldo Final: R$ ${saldo.toFixed(2)}</p>
  `;
  save();
}

/* ===== PDV ===== */
function addItem(){
  const [nome,valor]=produto.value.split("|");
  carrinho.push({nome,valor:+valor});
  renderCarrinho();
}

function finalizarVenda(){
  if(!carrinho.length) return;
  const total=carrinho.reduce((s,i)=>s+i.valor,0);
  db.vendas.push({
    data:new Date().toLocaleString(),
    total,
    pagamento:pagamento.value
  });
  carrinho=[];
  save();render();
}

function renderCarrinho(){
  let html="<tr><th>Item</th><th>Valor</th></tr>",soma=0;
  carrinho.forEach(i=>{
    html+=`<tr><td>${i.nome}</td><td>R$ ${i.valor.toFixed(2)}</td></tr>`;
    soma+=i.valor;
  });
  carrinho.innerHTML=html;
  total.innerText=soma.toFixed(2);
}

/* ===== DESPESAS ===== */
function salvarDespesa(){
  if(!descDespesa.value||!valorDespesa.value)return;
  db.despesas.push({
    desc:descDespesa.value,
    valor:+valorDespesa.value,
    data:new Date().toLocaleString()
  });
  descDespesa.value="";valorDespesa.value="";
  save();render();
}

/* ===== RELATÃ“RIO MENSAL ===== */
function gerarRelatorioMensal(){
  const mes=mesRelatorio.value;
  if(!mes)return alert("Selecione o mÃªs");

  const [ano,m]=mes.split("-");
  const vendas=db.vendas.filter(v=>{
    const d=new Date(v.data);
    return d.getFullYear()==ano && (d.getMonth()+1)==m;
  });

  const despesas=db.despesas.filter(d=>{
    const dt=new Date(d.data);
    return dt.getFullYear()==ano && (dt.getMonth()+1)==m;
  });

  const pix=vendas.filter(v=>v.pagamento==="pix").reduce((s,v)=>s+v.total,0);
  const cartao=vendas.filter(v=>v.pagamento==="cartao").reduce((s,v)=>s+v.total,0);
  const dinheiro=vendas.filter(v=>v.pagamento==="dinheiro").reduce((s,v)=>s+v.total,0);
  const faturamento=pix+cartao+dinheiro;
  const totalDesp=despesas.reduce((s,d)=>s+d.valor,0);

  resumoMensal.innerHTML=`
    <h3>${m}/${ano}</h3>
    <p>Pix: R$ ${pix.toFixed(2)}</p>
    <p>CartÃ£o: R$ ${cartao.toFixed(2)}</p>
    <p>Dinheiro: R$ ${dinheiro.toFixed(2)}</p>
    <p>Faturamento: R$ ${faturamento.toFixed(2)}</p>
    <p>Despesas: R$ ${totalDesp.toFixed(2)}</p>
    <p class="total">Lucro: R$ ${(faturamento-totalDesp).toFixed(2)}</p>
  `;

  listaMensal.innerHTML=vendas.map(v=>
    `<li>${v.data} | ${v.pagamento} | R$ ${v.total.toFixed(2)}</li>`
  ).join("");
}

function pdfRelatorioMensal(){
  if(!mesRelatorio.value)return;
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=10;

  pdf.text("RELATÃ“RIO MENSAL",10,y);y+=10;
  pdf.text("MÃªs: "+mesRelatorio.value,10,y);y+=10;

  listaMensal.querySelectorAll("li").forEach(li=>{
    pdf.text(li.innerText,10,y);
    y+=8;
    if(y>270){pdf.addPage();y=10;}
  });

  pdf.save("relatorio-mensal.pdf");
}

/* ===== PDF FECHAMENTO ===== */
function pdfFechamento(){
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  let y=10;
  pdf.text("FECHAMENTO DE CAIXA",10,y);y+=10;
  db.vendas.forEach(v=>{
    pdf.text(`${v.data} | ${v.pagamento} | R$ ${v.total.toFixed(2)}`,10,y);
    y+=8;
    if(y>270){pdf.addPage();y=10;}
  });
  pdf.save("fechamento-caixa.pdf");
}

/* ===== RENDER ===== */
function render(){
  statusCaixa.innerText=db.caixa.aberto?"ðŸŸ¢ Caixa aberto":"ðŸ”´ Caixa fechado";
  produto.innerHTML=db.produtos
    .map(p=>`<option value="${p.nome}|${p.valor}">${p.nome} - R$ ${p.valor}</option>`).join("");
  listaDespesas.innerHTML=db.despesas
    .map(d=>`<li>${d.desc} - R$ ${d.valor.toFixed(2)}</li>`).join("");

  const vendas=db.vendas.reduce((s,v)=>s+v.total,0);
  const desp=db.despesas.reduce((s,d)=>s+d.valor,0);
  fat.innerText=vendas.toFixed(2);
  document.getElementById("desp").innerText=desp.toFixed(2);
  lucro.innerText=(vendas-desp).toFixed(2);

  renderCarrinho();
}
render();
</script>

</body>
</html>
