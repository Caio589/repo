<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PDV Barbearia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:url("https://images.unsplash.com/photo-1503951914875-452162b0f3f1");
  background-size:cover;
  background-position:center;
}
.overlay{background:rgba(0,0,0,.75);min-height:100vh}
.menu{
  position:fixed;left:0;top:0;bottom:0;width:70px;
  background:rgba(0,0,0,.4);
  display:flex;flex-direction:column;align-items:center;padding-top:20px
}
.menu button{background:none;border:none;color:#f1c40f;font-size:22px;margin:15px 0;cursor:pointer}
.content{margin-left:90px;padding:20px;color:#fff}
.section{display:none}
.section.active{display:block}
input,select,button{padding:8px;border-radius:6px;border:none;margin:4px 0}
button{cursor:pointer;font-weight:bold}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid rgba(255,255,255,.2);padding:6px}
.total{font-size:20px;color:#2ecc71}
.neg{color:#e74c3c}
canvas{background:#111;border-radius:8px;margin-top:10px}
</style>
</head>

<body>
<div class="overlay">

<div class="menu">
  <button onclick="show('pdv')">游눋</button>
  <button onclick="show('agenda')">游</button>
  <button onclick="show('clientes')">游녻</button>
  <button onclick="show('planos')">游눱</button>
  <button onclick="show('produtos')">游닍</button>
  <button onclick="show('despesas')">游</button>
  <button onclick="show('mensal')">游늱</button>
</div>

<div class="content">

<!-- PDV -->
<div id="pdv" class="section active">
  <h2>PDV / Caixa</h2>
  <p id="statusCaixa"></p>

  <input id="valorAbertura" type="number" placeholder="Valor abertura do caixa">
  <button onclick="abrirCaixa()">Abrir Caixa</button>

  <select id="cliente"></select>
  <select id="produto"></select>
  <select id="pagamento">
    <option value="dinheiro">Dinheiro</option>
    <option value="pix">Pix</option>
    <option value="cartao">Cart칚o</option>
  </select>

  <button onclick="addItem()">Adicionar</button>

  <table id="carrinho"></table>
  <p class="total">Total: R$ <span id="total">0.00</span></p>

  <button onclick="finalizarVenda()">Finalizar Venda</button>
  <button onclick="fecharCaixa()">Fechar Caixa</button>
  <button onclick="pdfFechamento()">游늯 PDF Fechamento</button>

  <div id="resumoCaixa"></div>
</div>

<!-- AGENDA -->
<div id="agenda" class="section">
  <h2>Agenda (15 em 15 min)</h2>
  <input type="date" id="dataAgenda">
  <select id="horaAgenda"></select>
  <select id="clienteAgenda"></select>
  <select id="servicoAgenda"></select>
  <button onclick="salvarAgendamento()">Agendar</button>
  <ul id="listaAgenda"></ul>
</div>

<!-- CLIENTES -->
<div id="clientes" class="section">
  <h2>Clientes</h2>
  <input id="nomeCliente" placeholder="Nome">
  <select id="planoCliente"></select>
  <button onclick="salvarCliente()">Salvar</button>
  <ul id="listaClientes"></ul>
</div>

<!-- PLANOS -->
<div id="planos" class="section">
  <h2>Planos</h2>
  <input id="nomePlano" placeholder="Nome">
  <input id="valorPlano" type="number" placeholder="Valor">
  <input id="qtdPlano" type="number" placeholder="Qtd">
  <select id="tipoPlano"></select>
  <button onclick="salvarPlano()">Salvar</button>
  <ul id="listaPlanos"></ul>
</div>

<!-- PRODUTOS -->
<div id="produtos" class="section">
  <h2>Produtos / Servi칞os</h2>
  <input id="nomeProd" placeholder="Nome">
  <input id="valorProd" type="number" placeholder="Valor">
  <select id="tipoProd">
    <option value="produto">Produto</option>
    <option value="servico">Servi칞o</option>
  </select>
  <button onclick="salvarProduto()">Salvar</button>
  <ul id="listaProdutos"></ul>
</div>

<!-- DESPESAS -->
<div id="despesas" class="section">
  <h2>Despesas</h2>
  <input id="descDespesa" placeholder="Descri칞칚o">
  <input id="valorDespesa" type="number" placeholder="Valor">
  <button onclick="salvarDespesa()">Adicionar</button>
  <ul id="listaDespesas"></ul>
</div>

<!-- RELAT칍RIO MENSAL -->
<div id="mensal" class="section">
  <h2>Relat칩rio Mensal</h2>
  <input type="month" id="mesRelatorio">
  <button onclick="gerarRelatorioMensal()">Gerar</button>
  <button onclick="pdfRelatorioMensal()">游늯 PDF</button>

  <div id="resumoMensal"></div>
  <canvas id="graficoMensal" width="360" height="200"></canvas>
  <ul id="listaMensal"></ul>
</div>

</div>
</div>

<script>
/* ========= FUN칂츾O SHOW ========= */
function show(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ========= DB ========= */
const rawDB = JSON.parse(localStorage.getItem("db")||"{}");
const db = {
  clientes: rawDB.clientes||[],
  planos: rawDB.planos||[],
  produtos: rawDB.produtos||[],
  vendas: rawDB.vendas||[],
  despesas: rawDB.despesas||[],
  agenda: rawDB.agenda||[],
  caixa: rawDB.caixa||{aberto:false,abertura:0}
};

let carrinho=[];
function save(){localStorage.setItem("db",JSON.stringify(db));}

/* ========= AGENDA 15/15 ========= */
function gerarHorarios15(){
  let h=[];
  for(let i=8;i<=20;i++){
    ["00","15","30","45"].forEach(m=>{
      h.push(`${String(i).padStart(2,"0")}:${m}`);
    });
  }
  return h;
}
function salvarAgendamento(){
  if(db.agenda.find(a=>a.data===dataAgenda.value&&a.hora===horaAgenda.value))
    return alert("Hor치rio ocupado");
  db.agenda.push({
    data:dataAgenda.value,
    hora:horaAgenda.value,
    cliente:clienteAgenda.value,
    servico:servicoAgenda.value
  });
  save();renderAgenda();
}
function renderAgenda(){
  listaAgenda.innerHTML=db.agenda
    .filter(a=>a.data===dataAgenda.value)
    .map(a=>`<li>${a.hora} | ${a.cliente} | ${a.servico}</li>`).join("");
}

/* ========= CAIXA ========= */
function abrirCaixa(){
  db.caixa.aberto=true;
  db.caixa.abertura=+valorAbertura.value||0;
  db.vendas=[];db.despesas=[];carrinho=[];
  save();render();
}
function fecharCaixa(){
  const total=db.vendas.reduce((s,v)=>s+v.total,0);
  const desp=db.despesas.reduce((s,d)=>s+d.valor,0);
  const saldo=db.caixa.abertura+total-desp;
  resumoCaixa.innerHTML=`<p>Saldo Final: R$ ${saldo.toFixed(2)}</p>`;
  db.caixa.aberto=false;
  save();render();
}

/* ========= PDV ========= */
function addItem(){
  const [nome,valor]=produto.value.split("|");
  carrinho.push({nome,valor:+valor});
  renderCarrinho();
}
function finalizarVenda(){
  const total=carrinho.reduce((s,i)=>s+i.valor,0);
  db.vendas.push({data:new Date().toLocaleString(),total,pagamento:pagamento.value});
  carrinho=[];save();render();
}
function renderCarrinho(){
  let h="<tr><th>Item</th><th>Valor</th></tr>",s=0;
  carrinho.forEach(i=>{h+=`<tr><td>${i.nome}</td><td>R$ ${i.valor.toFixed(2)}</td></tr>`;s+=i.valor});
  carrinho.innerHTML=h;total.innerText=s.toFixed(2);
}

/* ========= CRUD ========= */
function salvarCliente(){db.clientes.push({nome:nomeCliente.value});save();render();}
function salvarPlano(){db.planos.push({nome:nomePlano.value,valor:+valorPlano.value,qtd:+qtdPlano.value,tipo:tipoPlano.value});save();render();}
function salvarProduto(){db.produtos.push({nome:nomeProd.value,valor:+valorProd.value,tipo:tipoProd.value});save();render();}
function salvarDespesa(){db.despesas.push({desc:descDespesa.value,valor:+valorDespesa.value,data:new Date().toLocaleString()});save();render();}

/* ========= RELAT칍RIO MENSAL + GR츼FICO ========= */
function gerarRelatorioMensal(){
  const [ano,m]=mesRelatorio.value.split("-");
  const vendas=db.vendas.filter(v=>{const d=new Date(v.data);return d.getFullYear()==ano&&(d.getMonth()+1)==m});
  const despesas=db.despesas.filter(d=>{const dt=new Date(d.data);return dt.getFullYear()==ano&&(dt.getMonth()+1)==m});
  const faturamento=vendas.reduce((s,v)=>s+v.total,0);
  const totalDesp=despesas.reduce((s,d)=>s+d.valor,0);
  const lucro=faturamento-totalDesp;

  resumoMensal.innerHTML=`
    <p>Faturamento: R$ ${faturamento.toFixed(2)}</p>
    <p>Despesas: R$ ${totalDesp.toFixed(2)}</p>
    <p class="total">Lucro L칤quido: R$ ${lucro.toFixed(2)}</p>
  `;

  desenharGrafico([faturamento,totalDesp,lucro]);
}
function desenharGrafico(val){
  const c=graficoMensal,g=c.getContext("2d");
  g.clearRect(0,0,c.width,c.height);
  const labels=["Faturamento","Despesas","Lucro"];
  const cores=["#2ecc71","#e74c3c","#3498db"];
  const max=Math.max(...val,1);
  val.forEach((v,i)=>{
    const h=(v/max)*120;
    g.fillStyle=cores[i];
    g.fillRect(50+i*90,160-h,50,h);
    g.fillText(labels[i],50+i*90,180);
  });
}

/* ========= PDF ========= */
function pdfFechamento(){
  const pdf=new jspdf.jsPDF();
  pdf.text("Fechamento de Caixa",10,10);
  db.vendas.forEach((v,i)=>pdf.text(`${v.data} - R$ ${v.total}`,10,20+i*8));
  pdf.save("fechamento.pdf");
}
function pdfRelatorioMensal(){
  const pdf=new jspdf.jsPDF();
  pdf.text("Relat칩rio Mensal",10,10);
  pdf.text(resumoMensal.innerText,10,20);
  pdf.save("relatorio-mensal.pdf");
}

/* ========= RENDER ========= */
function render(){
  statusCaixa.innerText=db.caixa.aberto?"游릭 Caixa aberto":"游댮 Caixa fechado";
  cliente.innerHTML=db.clientes.map(c=>`<option>${c.nome}</option>`).join("");
  clienteAgenda.innerHTML=cliente.innerHTML;
  planoCliente.innerHTML=db.planos.map(p=>`<option>${p.nome}</option>`).join("");
  tipoPlano.innerHTML=db.produtos.filter(p=>p.tipo==="servico").map(p=>`<option>${p.nome}</option>`).join("");
  produto.innerHTML=db.produtos.map(p=>`<option value="${p.nome}|${p.valor}">${p.nome}</option>`).join("");
  servicoAgenda.innerHTML=db.produtos.filter(p=>p.tipo==="servico").map(p=>`<option>${p.nome}</option>`).join("");
  horaAgenda.innerHTML=gerarHorarios15().map(h=>`<option>${h}</option>`).join("");
  renderCarrinho();
}
render();
</script>

</body>
</html>
