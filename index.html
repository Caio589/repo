<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PDV Barbearia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:url("https://images.unsplash.com/photo-1503951914875-452162b0f3f1");
  background-size:cover;
  background-position:center;
}
.overlay{background:rgba(0,0,0,.65);min-height:100vh;}
.menu{
  position:fixed;left:0;top:0;bottom:0;width:70px;
  background:rgba(0,0,0,.35);
  display:flex;flex-direction:column;align-items:center;padding-top:20px;
}
.menu button{
  background:none;border:none;color:#f1c40f;font-size:22px;
  margin:15px 0;cursor:pointer;
}
.content{margin-left:90px;padding:20px;color:#fff;}
.section{display:none}
.section.active{display:block}
input,select,button{padding:8px;border-radius:6px;border:none;margin:4px 0}
button{cursor:pointer;font-weight:bold}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid rgba(255,255,255,.2);padding:6px}
.total{font-size:22px;color:#2ecc71}
</style>
</head>

<body>
<div class="overlay">

<div class="menu">
  <button onclick="show('pdv')">ðŸ’ˆ</button>
  <button onclick="show('clientes')">ðŸ‘¤</button>
  <button onclick="show('planos')">ðŸ’³</button>
  <button onclick="show('produtos')">ðŸ“¦</button>
  <button onclick="show('despesas')">ðŸ§¾</button>
  <button onclick="show('financeiro')">ðŸ“Š</button>
</div>

<div class="content">

<!-- PDV -->
<div id="pdv" class="section active">
  <h2>PDV / Caixa</h2>
  <p id="statusCaixa"></p>

  <select id="cliente"></select>
  <select id="produto"></select>
  <button onclick="addItem()">Adicionar</button>

  <table id="carrinho"></table>
  <p class="total">Total: R$ <span id="total">0.00</span></p>

  <button onclick="finalizarVenda()">Finalizar Venda</button>
  <button onclick="abrirCaixa()">Abrir Caixa</button>
  <button onclick="fecharCaixa()">Fechar Caixa</button>
  <button onclick="pdfCaixa()">ðŸ“„ PDF Caixa</button>
</div>

<!-- CLIENTES -->
<div id="clientes" class="section">
  <h2>Clientes</h2>
  <input id="nomeCliente" placeholder="Nome do cliente">
  <select id="planoCliente"></select>
  <button onclick="salvarCliente()">Salvar Cliente</button>
  <ul id="listaClientes"></ul>
</div>

<!-- PLANOS -->
<div id="planos" class="section">
  <h2>Planos</h2>
  <input id="nomePlano" placeholder="Nome do plano">
  <input id="valorPlano" type="number" placeholder="Valor do plano">
  <input id="qtdPlano" type="number" placeholder="Qtd procedimentos">
  <input id="tipoPlano" placeholder="Tipo serviÃ§o (ex: corte)">
  <button onclick="salvarPlano()">Salvar Plano</button>
  <ul id="listaPlanos"></ul>
</div>

<!-- PRODUTOS -->
<div id="produtos" class="section">
  <h2>Produtos / ServiÃ§os</h2>
  <input id="nomeProd" placeholder="Nome">
  <input id="valorProd" type="number" placeholder="Valor">
  <select id="tipoProd">
    <option value="produto">Produto</option>
    <option value="servico">ServiÃ§o</option>
  </select>
  <button onclick="salvarProduto()">Salvar</button>
  <ul id="listaProdutos"></ul>
</div>

<!-- DESPESAS -->
<div id="despesas" class="section">
  <h2>Despesas</h2>
  <input id="descDespesa" placeholder="DescriÃ§Ã£o">
  <input id="valorDespesa" type="number" placeholder="Valor">
  <button onclick="salvarDespesa()">Salvar</button>
  <ul id="listaDespesas"></ul>
</div>

<!-- FINANCEIRO -->
<div id="financeiro" class="section">
  <h2>Financeiro</h2>
  <p>Faturamento: R$ <span id="fat"></span></p>
  <p>Despesas: R$ <span id="desp"></span></p>
  <p class="total">Lucro: R$ <span id="lucro"></span></p>
  <button onclick="pdfFinanceiro()">ðŸ“Š PDF Financeiro</button>
</div>

</div>
</div>

<script>
// ===== DB SEGURO =====
const rawDB = JSON.parse(localStorage.getItem("db") || "{}");
const db = {
  clientes: Array.isArray(rawDB.clientes) ? rawDB.clientes : [],
  planos: Array.isArray(rawDB.planos) ? rawDB.planos : [],
  produtos: Array.isArray(rawDB.produtos) ? rawDB.produtos : [],
  vendas: Array.isArray(rawDB.vendas) ? rawDB.vendas : [],
  despesas: Array.isArray(rawDB.despesas) ? rawDB.despesas : [],
  caixa: rawDB.caixa || { aberto:false }
};

let carrinho=[];

function save(){ localStorage.setItem("db", JSON.stringify(db)); }

function show(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  render();
}

// ===== RENDER =====
function render(){
  statusCaixa.innerText = db.caixa.aberto ? "ðŸŸ¢ Caixa aberto" : "ðŸ”´ Caixa fechado";

  cliente.innerHTML = db.clientes.map(c=>`<option>${c.nome}</option>`).join("");
  produto.innerHTML = db.produtos.map(p=>`<option>${p.nome}|${p.valor}|${p.tipo}</option>`).join("");

  planoCliente.innerHTML =
    `<option value="">Sem plano</option>` +
    db.planos.map(p=>`<option>${p.nome}</option>`).join("");

  listaClientes.innerHTML = db.clientes.map(c =>
    `<li>${c.nome} | Plano: ${c.plano||"-"} | Saldo: ${c.saldo||0}</li>`
  ).join("");

  listaPlanos.innerHTML = db.planos.map(p =>
    `<li>${p.nome} - R$ ${p.valor} (${p.qtd}x ${p.tipo})</li>`
  ).join("");

  listaProdutos.innerHTML = db.produtos.map(p =>
    `<li>${p.nome} (${p.tipo})</li>`
  ).join("");

  listaDespesas.innerHTML = db.despesas.map(d =>
    `<li>${d.desc} - R$ ${d.valor}</li>`
  ).join("");

  carrinhoRender();
  financeiroRender();
}

// ===== CARRINHO =====
function carrinhoRender(){
  let html="<tr><th>Item</th><th>Valor</th></tr>";
  let soma=0;
  carrinho.forEach(i=>{
    html+=`<tr><td>${i.nome}</td><td>R$ ${i.valor.toFixed(2)}</td></tr>`;
    soma+=i.valor;
  });
  carrinho.innerHTML=html;
  total.innerText=soma.toFixed(2);
}

// ===== CAIXA =====
function abrirCaixa(){ db.caixa.aberto=true; save(); render(); }
function fecharCaixa(){ db.caixa.aberto=false; save(); render(); }

// ===== PDV =====
function addItem(){
  if(!db.caixa.aberto) return alert("Abra o caixa");

  const [nome,valor,tipo] = produto.value.split("|");
  const cli = db.clientes.find(c=>c.nome===cliente.value);

  if(cli && cli.plano && tipo==="servico" && cli.saldo>0){
    cli.saldo--;
    save();
    alert("Plano usado. Saldo: "+cli.saldo);
    render();
    return;
  }

  carrinho.push({nome,valor:Number(valor)});
  carrinhoRender();
}

function finalizarVenda(){
  if(carrinho.length===0) return;

  const totalVenda = carrinho.reduce((s,i)=>s+i.valor,0);

  db.vendas.push({
    data: new Date().toLocaleString(),
    cliente: cliente.value,
    itens: [...carrinho],
    total: totalVenda
  });

  carrinho=[];
  save();
  render();
}

// ===== CADASTROS =====
function salvarCliente(){
  const plano = db.planos.find(p=>p.nome===planoCliente.value);
  db.clientes.push({
    nome:nomeCliente.value,
    plano:plano?plano.nome:null,
    saldo:plano?plano.qtd:0
  });

  if(plano){
    db.vendas.push({
      data:new Date().toLocaleString(),
      cliente:nomeCliente.value,
      itens:[{nome:"Plano "+plano.nome, valor:plano.valor}],
      total:plano.valor
    });
  }

  save();
  render();
}

function salvarPlano(){
  db.planos.push({
    nome:nomePlano.value,
    valor:Number(valorPlano.value),
    qtd:Number(qtdPlano.value),
    tipo:tipoPlano.value.toLowerCase()
  });
  save();
  render();
}

function salvarProduto(){
  db.produtos.push({
    nome:nomeProd.value,
    valor:Number(valorProd.value),
    tipo:tipoProd.value
  });
  save();
  render();
}

function salvarDespesa(){
  db.despesas.push({
    desc:descDespesa.value,
    valor:Number(valorDespesa.value)
  });
  save();
  render();
}

// ===== FINANCEIRO =====
function financeiroRender(){
  const faturamento = db.vendas.reduce((s,v)=>s+v.total,0);
  const despesas = db.despesas.reduce((s,d)=>s+d.valor,0);
  fat.innerText=faturamento.toFixed(2);
  desp.innerText=despesas.toFixed(2);
  lucro.innerText=(faturamento-despesas).toFixed(2);
}

// ===== PDF CAIXA =====
function pdfCaixa(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  let y = 10;
  pdf.text("RESUMO DO CAIXA",10,y); y+=10;
  pdf.text("Data: "+new Date().toLocaleString(),10,y); y+=10;

  db.vendas.forEach(v=>{
    pdf.text(`â€¢ ${v.data} | ${v.cliente} | R$ ${v.total.toFixed(2)}`,10,y);
    y+=8;
    if(y>270){ pdf.addPage(); y=10; }
  });

  pdf.save("resumo-caixa.pdf");
}

// ===== PDF FINANCEIRO =====
function pdfFinanceiro(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();

  const faturamento=db.vendas.reduce((s,v)=>s+v.total,0);
  const despesas=db.despesas.reduce((s,d)=>s+d.valor,0);

  pdf.text("RELATÃ“RIO FINANCEIRO",10,10);
  pdf.text("Faturamento: R$ "+faturamento.toFixed(2),10,30);
  pdf.text("Despesas: R$ "+despesas.toFixed(2),10,40);
  pdf.text("Lucro: R$ "+(faturamento-despesas).toFixed(2),10,50);

  pdf.save("relatorio-financeiro.pdf");
}

render();
</script>

</body>
</html>
