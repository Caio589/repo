<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PDV Barbearia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#111;color:#fff}
.menu{position:fixed;left:0;top:0;bottom:0;width:70px;background:#0008;
display:flex;flex-direction:column;align-items:center;padding-top:20px}
.menu button{background:none;border:none;color:#f1c40f;font-size:22px;margin:15px 0;cursor:pointer}
.content{margin-left:90px;padding:20px}
.section{display:none}
.section.active{display:block}
input,select,button{padding:8px;border-radius:6px;border:none;margin:4px}
button{cursor:pointer;font-weight:bold}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #444;padding:6px}
.total{font-size:20px;color:#2ecc71}
</style>
</head>

<body>

<div class="menu">
  <button onclick="show('pdv')">ğŸ’ˆ</button>
  <button onclick="show('agenda')">ğŸ“…</button>
  <button onclick="show('clientes')">ğŸ‘¤</button>
  <button onclick="show('planos')">ğŸ’³</button>
  <button onclick="show('produtos')">ğŸ“¦</button>
  <button onclick="show('financeiro')">ğŸ“Š</button>
</div>

<div class="content">

<!-- PDV -->
<div id="pdv" class="section active">
  <h2>PDV / Caixa</h2>
  <p id="statusCaixa"></p>
  <select id="cliente"></select>
  <select id="produto"></select>
  <button onclick="addItem()">Adicionar</button>
  <table id="carrinho"></table>
  <p class="total">Total: R$ <span id="total">0.00</span></p>
  <button onclick="finalizarVenda()">Finalizar Venda</button>
  <button onclick="abrirCaixa()">Abrir Caixa</button>
  <button onclick="fecharCaixa()">Fechar Caixa</button>
</div>

<!-- AGENDA -->
<div id="agenda" class="section">
  <h2>Agenda</h2>
  <input type="date" id="dataAgenda">
  <select id="horaAgenda"></select>
  <select id="clienteAgenda"></select>
  <select id="servicoAgenda"></select>
  <button onclick="salvarAgendamento()">Agendar</button>
  <ul id="listaAgenda"></ul>
</div>

<!-- CLIENTES -->
<div id="clientes" class="section">
  <h2>Clientes</h2>
  <input id="nomeCliente" placeholder="Nome">
  <select id="planoCliente"></select>
  <button onclick="salvarCliente()">ğŸ’¾ Salvar</button>
  <ul id="listaClientes"></ul>
</div>

<!-- PLANOS -->
<div id="planos" class="section">
  <h2>Planos</h2>
  <input id="nomePlano" placeholder="Nome">
  <input id="valorPlano" type="number" placeholder="Valor">
  <input id="qtdPlano" type="number" placeholder="Qtd">
  <select id="tipoPlano"></select>
  <button onclick="salvarPlano()">ğŸ’¾ Salvar</button>
  <ul id="listaPlanos"></ul>
</div>

<!-- PRODUTOS -->
<div id="produtos" class="section">
  <h2>Produtos / ServiÃ§os</h2>
  <input id="nomeProd" placeholder="Nome">
  <input id="valorProd" type="number" placeholder="Valor">
  <select id="tipoProd">
    <option value="produto">Produto</option>
    <option value="servico">ServiÃ§o</option>
  </select>
  <button onclick="salvarProduto()">ğŸ’¾ Salvar</button>
  <ul id="listaProdutos"></ul>
</div>

<!-- FINANCEIRO -->
<div id="financeiro" class="section">
  <h2>Financeiro</h2>
  <p>Faturamento: R$ <span id="fat">0.00</span></p>
  <p>Despesas: R$ <span id="desp">0.00</span></p>
  <p class="total">Lucro: R$ <span id="lucro">0.00</span></p>
</div>

</div>

<script>
// ===== DB =====
const rawDB = JSON.parse(localStorage.getItem("db")||"{}");
const db = {
  clientes: rawDB.clientes||[],
  planos: rawDB.planos||[],
  produtos: rawDB.produtos||[],
  vendas: rawDB.vendas||[],
  despesas: rawDB.despesas||[],
  agenda: rawDB.agenda||[],
  caixa: rawDB.caixa||{aberto:false}
};

let carrinho=[];
let editCliente=null, editPlano=null, editProduto=null;

function save(){localStorage.setItem("db",JSON.stringify(db));}

function show(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  render();
}

// ===== HORÃRIOS =====
function gerarHorarios(){
  let h=[];
  for(let i=8;i<=20;i++){
    h.push(`${String(i).padStart(2,"0")}:00`);
    h.push(`${String(i).padStart(2,"0")}:30`);
  }
  return h;
}

// ===== RENDER =====
function render(){
  statusCaixa.innerText=db.caixa.aberto?"ğŸŸ¢ Caixa aberto":"ğŸ”´ Caixa fechado";

  cliente.innerHTML=db.clientes.map(c=>`<option>${c.nome}</option>`).join("");
  produto.innerHTML=db.produtos.map(p=>`<option>${p.nome}|${p.valor}|${p.tipo}</option>`).join("");

  planoCliente.innerHTML=`<option value="">Sem plano</option>`+
    db.planos.map(p=>`<option>${p.nome}</option>`).join("");

  tipoPlano.innerHTML=db.produtos.filter(p=>p.tipo==="servico")
    .map(p=>`<option>${p.nome}</option>`).join("");

  listaClientes.innerHTML=db.clientes.map((c,i)=>`
    <li>${c.nome} | Plano: ${c.plano||"-"} | Saldo: ${c.saldo||0}
      <button onclick="editarCliente(${i})">âœï¸</button>
      <button onclick="excluirCliente(${i})">ğŸ—‘ï¸</button>
    </li>`).join("");

  listaPlanos.innerHTML=db.planos.map((p,i)=>`
    <li>${p.nome} (${p.qtd}x ${p.tipo})
      <button onclick="editarPlano(${i})">âœï¸</button>
      <button onclick="excluirPlano(${i})">ğŸ—‘ï¸</button>
    </li>`).join("");

  listaProdutos.innerHTML=db.produtos.map((p,i)=>`
    <li>${p.nome} (${p.tipo})
      <button onclick="editarProduto(${i})">âœï¸</button>
      <button onclick="excluirProduto(${i})">ğŸ—‘ï¸</button>
    </li>`).join("");

  horaAgenda.innerHTML=gerarHorarios().map(h=>`<option>${h}</option>`).join("");
  clienteAgenda.innerHTML=cliente.innerHTML;
  servicoAgenda.innerHTML=db.produtos.filter(p=>p.tipo==="servico")
    .map(p=>`<option>${p.nome}</option>`).join("");

  carrinhoRender();
  financeiroRender();
  renderAgenda();
}

// ===== PDV =====
function addItem(){
  if(!db.caixa.aberto) return alert("Abra o caixa");

  const [nome,valor,tipo]=produto.value.split("|");
  const cli=db.clientes.find(c=>c.nome===cliente.value);

  if(cli && cli.plano && tipo==="servico" &&
     !db.planos.find(p=>p.nome===cli.plano && p.tipo===nome))
    return alert("ServiÃ§o nÃ£o permitido no plano");

  if(cli && cli.plano && tipo==="servico" && cli.saldo>0 &&
     db.planos.find(p=>p.nome===cli.plano && p.tipo===nome)){
    cli.saldo--;
    save(); render();
    return alert("Plano usado. Saldo: "+cli.saldo);
  }

  carrinho.push({nome,valor:+valor});
  carrinhoRender();
}

function carrinhoRender(){
  let html="<tr><th>Item</th><th>Valor</th></tr>", soma=0;
  carrinho.forEach(i=>{
    html+=`<tr><td>${i.nome}</td><td>R$ ${i.valor.toFixed(2)}</td></tr>`;
    soma+=i.valor;
  });
  carrinho.innerHTML=html;
  total.innerText=soma.toFixed(2);
}

function finalizarVenda(){
  if(!carrinho.length) return;
  const t=carrinho.reduce((s,i)=>s+i.valor,0);
  db.vendas.push({data:new Date().toLocaleString(),cliente:cliente.value,total:t});
  carrinho=[]; save(); render();
}

function abrirCaixa(){db.caixa.aberto=true;save();render();}
function fecharCaixa(){db.caixa.aberto=false;save();render();}

// ===== CRUD =====
function salvarCliente(){
  const p=db.planos.find(pl=>pl.nome===planoCliente.value);
  const obj={nome:nomeCliente.value,plano:p?p.nome:null,saldo:p?p.qtd:0};
  editCliente!==null?db.clientes[editCliente]=obj:db.clientes.push(obj);
  editCliente=null; nomeCliente.value="";
  save(); render();
}
function editarCliente(i){
  const c=db.clientes[i];
  nomeCliente.value=c.nome; planoCliente.value=c.plano||"";
  editCliente=i;
}
function excluirCliente(i){
  if(confirm("Excluir cliente?")){
    db.clientes.splice(i,1); save(); render();
  }
}

function salvarPlano(){
  const obj={nome:nomePlano.value,valor:+valorPlano.value,qtd:+qtdPlano.value,tipo:tipoPlano.value};
  editPlano!==null?db.planos[editPlano]=obj:db.planos.push(obj);
  editPlano=null; nomePlano.value="";
  save(); render();
}
function editarPlano(i){
  const p=db.planos[i];
  nomePlano.value=p.nome; valorPlano.value=p.valor;
  qtdPlano.value=p.qtd; tipoPlano.value=p.tipo;
  editPlano=i;
}
function excluirPlano(i){
  if(confirm("Excluir plano?")){
    db.planos.splice(i,1); save(); render();
  }
}

function salvarProduto(){
  const obj={nome:nomeProd.value,valor:+valorProd.value,tipo:tipoProd.value};
  editProduto!==null?db.produtos[editProduto]=obj:db.produtos.push(obj);
  editProduto=null; nomeProd.value="";
  save(); render();
}
function editarProduto(i){
  const p=db.produtos[i];
  nomeProd.value=p.nome; valorProd.value=p.valor; tipoProd.value=p.tipo;
  editProduto=i;
}
function excluirProduto(i){
  if(confirm("Excluir item?")){
    db.produtos.splice(i,1); save(); render();
  }
}

// ===== AGENDA =====
function renderAgenda(){
  if(!dataAgenda.value) return;
  listaAgenda.innerHTML=db.agenda
    .filter(a=>a.data===dataAgenda.value)
    .sort((a,b)=>a.hora.localeCompare(b.hora))
    .map(a=>`<li>${a.hora} | ${a.cliente} | ${a.servico}</li>`).join("");
}
function salvarAgendamento(){
  if(db.agenda.find(a=>a.data===dataAgenda.value && a.hora===horaAgenda.value))
    return alert("HorÃ¡rio ocupado");
  db.agenda.push({
    data:dataAgenda.value,
    hora:horaAgenda.value,
    cliente:clienteAgenda.value,
    servico:servicoAgenda.value
  });
  save(); renderAgenda();
}

// ===== FINANCEIRO =====
function financeiroRender(){
  const f=db.vendas.reduce((s,v)=>s+v.total,0);
  const d=db.despesas.reduce((s,i)=>s+i.valor,0);
  fat.innerText=f.toFixed(2);
  desp.innerText=d.toFixed(2);
  lucro.innerText=(f-d).toFixed(2);
}

render();
</script>

</body>
</html>
