<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PDV Barbearia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:url("https://images.unsplash.com/photo-1503951914875-452162b0f3f1");background-size:cover;background-position:center}
.overlay{background:rgba(0,0,0,.75);min-height:100vh}
.menu{position:fixed;left:0;top:0;bottom:0;width:70px;background:rgba(0,0,0,.4);display:flex;flex-direction:column;align-items:center;padding-top:20px}
.menu button{background:none;border:none;color:#f1c40f;font-size:22px;margin:15px 0;cursor:pointer}
.content{margin-left:90px;padding:20px;color:#fff}
.section{display:none}.section.active{display:block}
input,select,button{padding:8px;border-radius:6px;border:none;margin:4px 0}
button{cursor:pointer;font-weight:bold}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid rgba(255,255,255,.2);padding:6px}
.total{font-size:20px;color:#2ecc71}
.neg{color:#e74c3c}.ok{color:#2ecc71}.warn{color:#f1c40f}
canvas{background:#111;border-radius:8px;margin-top:10px}
small{color:#ccc}
</style>
</head>

<body>
<div class="overlay">

<div class="menu">
  <button onclick="show('pdv')">ðŸ’ˆ</button>
  <button onclick="show('agenda')">ðŸ•’</button>
  <button onclick="show('clientes')">ðŸ‘¤</button>
  <button onclick="show('planos')">ðŸ’³</button>
  <button onclick="show('produtos')">ðŸ“¦</button>
  <button onclick="show('despesas')">ðŸ§¾</button>
  <button onclick="show('mensal')">ðŸ“†</button>
  <button onclick="show('historico')">ðŸ“š</button>
</div>

<div class="content">

<!-- ================= PDV ================= -->
<div id="pdv" class="section active">
  <h2>PDV / Caixa</h2>
  <p id="statusCaixa"></p>

  <input id="valorAbertura" type="number" placeholder="Valor de abertura">
  <button onclick="abrirCaixa()">Abrir Caixa</button>

  <h4>PerÃ­odo do Caixa</h4>
  <input type="date" id="periodoInicio">
  <input type="date" id="periodoFim">

  <hr>

  <select id="cliente"></select>
  <select id="produto"></select>
  <select id="pagamento">
    <option value="dinheiro">Dinheiro</option>
    <option value="pix">Pix</option>
    <option value="cartao">CartÃ£o</option>
  </select>

  <button onclick="addItem()">Adicionar</button>

  <table id="carrinho"></table>
  <p class="total">Total: R$ <span id="total">0.00</span></p>

  <button onclick="finalizarVenda()">Finalizar Venda</button>
  <button onclick="fecharCaixa()">Fechar Caixa</button>

  <div id="resumoCaixa"></div>

  <h4>ConferÃªncia de Dinheiro</h4>
  <input id="dinheiroContado" type="number" placeholder="Dinheiro contado">
  <p id="resultadoConferencia"></p>

  <canvas id="graficoCaixa" width="380" height="200"></canvas>
</div>

<!-- ================= HISTÃ“RICO ================= -->
<div id="historico" class="section">
  <h2>HistÃ³rico de Fechamentos</h2>
  <ul id="listaHistorico"></ul>
</div>

<!-- ================= AGENDA ================= -->
<div id="agenda" class="section">
  <h2>Agenda (15 em 15)</h2>
  <input type="date" id="dataAgenda">
  <select id="horaAgenda"></select>
  <select id="clienteAgenda"></select>
  <select id="servicoAgenda"></select>
  <button onclick="salvarAgendamento()">Agendar</button>
  <ul id="listaAgenda"></ul>
</div>

<!-- ================= CLIENTES ================= -->
<div id="clientes" class="section">
  <h2>Clientes</h2>
  <input id="nomeCliente" placeholder="Nome">
  <select id="planoCliente"></select>
  <button onclick="salvarCliente()">Salvar</button>
  <ul id="listaClientes"></ul>
</div>

<!-- ================= PLANOS ================= -->
<div id="planos" class="section">
  <h2>Planos</h2>
  <input id="nomePlano" placeholder="Nome">
  <input id="valorPlano" type="number" placeholder="Valor">
  <input id="qtdPlano" type="number" placeholder="Qtd serviÃ§os">
  <select id="tipoPlano"></select>
  <button onclick="salvarPlano()">Salvar</button>
  <ul id="listaPlanos"></ul>
</div>

<!-- ================= PRODUTOS ================= -->
<div id="produtos" class="section">
  <h2>Produtos / ServiÃ§os</h2>
  <input id="nomeProd" placeholder="Nome">
  <input id="valorProd" type="number" placeholder="Valor">
  <select id="tipoProd">
    <option value="produto">Produto</option>
    <option value="servico">ServiÃ§o</option>
  </select>
  <button onclick="salvarProduto()">Salvar</button>
  <ul id="listaProdutos"></ul>
</div>

<!-- ================= DESPESAS ================= -->
<div id="despesas" class="section">
  <h2>Despesas</h2>
  <input id="descDespesa" placeholder="DescriÃ§Ã£o">
  <input id="valorDespesa" type="number" placeholder="Valor">
  <select id="tipoDespesa">
    <option value="variavel">VariÃ¡vel</option>
    <option value="fixa">Fixa mensal</option>
  </select>
  <button onclick="salvarDespesa()">Salvar</button>
  <ul id="listaDespesas"></ul>
</div>

<!-- ================= RELATÃ“RIO MENSAL ================= -->
<div id="mensal" class="section">
  <h2>RelatÃ³rio Mensal</h2>
  <input type="month" id="mesRelatorio">
  <button onclick="gerarRelatorioMensal()">Gerar</button>
  <div id="resumoMensal"></div>
  <canvas id="graficoMensal" width="380" height="200"></canvas>
</div>

</div>
</div>

<script>
function show(id){document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));document.getElementById(id).classList.add("active")}

const rawDB=JSON.parse(localStorage.getItem("db")||"{}");
const db={
  clientes:rawDB.clientes||[],
  planos:rawDB.planos||[],
  produtos:rawDB.produtos||[],
  vendas:rawDB.vendas||[],
  despesas:rawDB.despesas||[],
  agenda:rawDB.agenda||[],
  historico:rawDB.historico||[],
  caixa:rawDB.caixa||{aberto:false,abertura:0}
};

let carrinho=[];
function save(){localStorage.setItem("db",JSON.stringify(db))}

/* ===== CAIXA COM PERÃODO ===== */
function abrirCaixa(){
  db.caixa.aberto=true;
  db.caixa.abertura=+valorAbertura.value||0;
  carrinho=[];
  save();render();
}

function fecharCaixa(){
  const ini=periodoInicio.value?new Date(periodoInicio.value):null;
  const fim=periodoFim.value?new Date(periodoFim.value+" 23:59:59"):null;

  let pix=0,cartao=0,dinheiro=0,planos=0;

  const vendasPeriodo=db.vendas.filter(v=>{
    const dt=new Date(v.data);
    if(ini&&dt<ini)return false;
    if(fim&&dt>fim)return false;
    return true;
  });

  vendasPeriodo.forEach(v=>{
    if(v.tipo==="plano")planos+=v.total;
    else{
      if(v.pagamento==="pix")pix+=v.total;
      if(v.pagamento==="cartao")cartao+=v.total;
      if(v.pagamento==="dinheiro")dinheiro+=v.total;
    }
  });

  const despesas=db.despesas
    .filter(d=>{
      if(d.tipo==="fixa")return false;
      const dt=new Date(d.data);
      if(ini&&dt<ini)return false;
      if(fim&&dt>fim)return false;
      return true;
    })
    .reduce((s,d)=>s+d.valor,0);

  const faturamento=pix+cartao+dinheiro+planos;
  const saldo=db.caixa.abertura+faturamento-despesas;

  const contado=+dinheiroContado.value||0;
  const diferenca=contado-dinheiro;

  db.historico.push({
    periodo:`${periodoInicio.value} atÃ© ${periodoFim.value}`,
    abertura:db.caixa.abertura,
    faturamento,
    pix,cartao,dinheiro,planos,
    despesas,
    saldo,
    contado,
    diferenca,
    dataFechamento:new Date().toLocaleString()
  });

  save();render();
}

/* ===== RELATÃ“RIO MENSAL ===== */
function gerarRelatorioMensal(){
  const [ano,m]=mesRelatorio.value.split("-");
  const vendas=db.vendas.filter(v=>{const d=new Date(v.data);return d.getFullYear()==ano&&(d.getMonth()+1)==m});
  const despesas=db.despesas.filter(d=>{
    if(d.tipo==="fixa")return true;
    const dt=new Date(d.data);
    return dt.getFullYear()==ano&&(dt.getMonth()+1)==m;
  });
  const fat=vendas.reduce((s,v)=>s+v.total,0);
  const desp=despesas.reduce((s,d)=>s+d.valor,0);
  const lucro=fat-desp;
  resumoMensal.innerHTML=`<p>Faturamento: R$ ${fat.toFixed(2)}</p><p>Despesas: R$ ${desp.toFixed(2)}</p><p class="total">Lucro: R$ ${lucro.toFixed(2)}</p>`;
}

/* ===== RENDER ===== */
function render(){
  statusCaixa.innerText=db.caixa.aberto?"ðŸŸ¢ Caixa aberto":"ðŸ”´ Caixa fechado";

  listaHistorico.innerHTML=db.historico.map(h=>`
    <li>
      <b>${h.periodo}</b><br>
      Faturamento: R$ ${h.faturamento.toFixed(2)}<br>
      Despesas: R$ ${h.despesas.toFixed(2)}<br>
      Saldo: R$ ${h.saldo.toFixed(2)}<br>
      DiferenÃ§a: R$ ${h.diferenca.toFixed(2)}<br>
      <small>${h.dataFechamento}</small>
    </li>
  `).join("");
}
render();
</script>

</body>
</html>
